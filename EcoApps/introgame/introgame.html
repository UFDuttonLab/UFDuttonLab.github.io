<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Planet of Florilandia</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f8ff;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }
        .panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 300px;
            flex: 1;
        }
        .main-panel {
            flex: 2;
        }
        h1 {
            color: #2e8b57;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        #game-screen {
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            font-weight: bold;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-top: 5px;
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .option-button {
            background-color: #4682b4;
            color: white;
            border: none;
            padding: 15px 25px;
            text-align: left;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .option-button:hover {
            background-color: #5f9ea0;
            transform: translateY(-2px);
        }
        .option-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .info-box {
            padding: 15px;
            background-color: #f0fff0;
            border: 1px solid #90ee90;
            border-radius: 8px;
        }
        #status-display p {
            margin: 5px 0;
            font-size: 1em;
            font-weight: bold;
        }
        #chart-container {
            margin-top: 20px;
            background-color: #f0fff0;
            border: 1px solid #90ee90;
            border-radius: 8px;
            padding: 15px;
        }
        #population-chart {
            background-color: #fff;
            border: 1px solid #ddd;
            display: block;
            width: 100%;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 10px;
            font-size: 0.9em;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
        }
        .food-web-canvas {
            border: 1px solid #ccc;
            background-color: #f8f8ff;
            cursor: pointer;
            margin-top: 10px;
        }
        .food-web-message {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
        .food-web-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .food-web-options .option-button {
            flex-grow: 1;
        }
        .top-half {
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 20px;
        }
        .top-half > div {
            flex: 1;
            min-width: 300px;
        }
        .bottom-half {
            width: 100%;
            margin-top: 20px;
        }
        .simulation-area {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .simulation-area > div {
            flex: 1;
            min-width: 300px;
        }
        .simulation-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        #chart-and-controls {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }
        #chart-and-controls > div {
            flex: 1;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-panel" class="panel">
        <h1>The Planet of Florilandia</h1>
        <div id="name-form">
            <h2>Ecosystem Design</h2>
            <p>Welcome, Xenobiologist! Your mission is to establish and manage the fragile ecosystem of Florilandia. You have been entrusted with choosing the alien plant and animal species that will inhabit this planet, but remember that the well-being of the entire ecosystem rests in your hands. Proceed with care, as every decision you make will have a lasting impact.</p>
            
            <h3>Name Your Species</h3>
            <div class="form-group">
                <label for="plant1-name">Plant 1:</label>
                <input type="text" id="plant1-name" value="Glow-moss">
            </div>
            <div class="form-group">
                <label for="plant2-name">Plant 2:</label>
                <input type="text" id="plant2-name" value="Sun-fern">
            </div>
            <div class="form-group">
                <label for="animal1-name">Animal 1:</label>
                <input type="text" id="animal1-name" value="Glidewing">
            </div>
            <div class="form-group">
                <label for="animal2-name">Animal 2:</label>
                <input type="text" id="animal2-name" value="Rock-crawler">
            </div>
            <div class="form-group">
                <label for="animal3-name">Animal 3:</label>
                <input type="text" id="animal3-name" value="Shadow-beast">
            </div>
            <div class="form-group">
                <label for="animal4-name">Animal 4:</label>
                <input type="text" id="animal4-name" value="Sky-strider">
            </div>
            <div class="form-group">
                <label for="animal5-name">Animal 5:</label>
                <input type="text" id="animal5-name" value="Void-viper">
            </div>
            <button class="option-button" onclick="showFoodWebForm()">Next: Define Food Web</button>
        </div>
    </div>

    <div id="foodweb-panel" class="panel" style="display: none;">
        <h2>Define Food Web & Populations</h2>
        <div id="foodweb-setup">
            <h3>Who eats who?</h3>
            <p>Click on a predator, then click on its prey to draw a relationship. Click the predator again to deselect.</p>
            <div class="food-web-message" id="food-web-message"></div>
            <canvas id="food-web-canvas" class="food-web-canvas"></canvas>
        </div>
        
        <div id="initial-population-form" style="display: none;">
            <h3>Set Starting Populations</h3>
            <div id="population-inputs"></div>
            <button class="option-button" onclick="startSimulation()">Start Simulation</button>
        </div>
        
        <button class="option-button" onclick="showPopulationForm()">Next: Set Populations</button>
    </div>
    
    <div id="game-panel" class="panel main-panel" style="display: none;">
        <div class="top-half">
            <div id="food-web-live-container">
                <h3>Current Food Web</h3>
                <div class="food-web-message" id="live-food-web-message">Click an animal to start drawing a new relationship.</div>
                <canvas id="live-food-web-canvas" class="food-web-canvas"></canvas>
            </div>
            <div id="chart-container">
                <h3>Population Trends Over Time</h3>
                <canvas id="population-chart"></canvas>
                <div class="chart-legend" id="chart-legend"></div>
            </div>
        </div>
        
        <div class="bottom-half">
            <div id="game-output"></div>
            <div class="simulation-area">
                <div class="info-box">
                    <h3>Current Ecosystem Status</h3>
                    <p>Your goal is to maintain a healthy, balanced ecosystem. Pay attention to population sizes and the food web.</p>
                    <div id="status-display"></div>
                </div>
                <div class="simulation-controls">
                    <div class="options-container" id="options-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Core Game Logic ---
    let ecosystem = {};
    let isGameOver = false;
    let speciesData = {};
    let foodWeb = {};

    const setupPanel = document.getElementById('setup-panel');
    const foodwebPanel = document.getElementById('foodweb-panel');
    const gamePanel = document.getElementById('game-panel');
    const gameOutput = document.getElementById('game-output');
    const optionsContainer = document.getElementById('options-container');
    const statusDisplay = document.getElementById('status-display');
    const chartCanvas = document.getElementById('population-chart');
    const chartContext = chartCanvas.getContext('2d');
    const chartLegend = document.getElementById('chart-legend');

    const foodWebCanvas = document.getElementById('food-web-canvas');
    const foodWebContext = foodWebCanvas.getContext('2d');
    const foodWebMessage = document.getElementById('food-web-message');
    const liveFoodWebCanvas = document.getElementById('live-food-web-canvas');
    const liveFoodWebContext = liveFoodWebCanvas.getContext('2d');
    const liveFoodWebMessage = document.getElementById('live-food-web-message');

    const chartData = {};
    const maxDataPoints = 15;
    const chartColors = {};
    const baseChartColors = ['#2e8b57', '#9acd32', '#a52a2a', '#8b4513', '#ffa500', '#4682b4', '#808080'];
    let speciesPositions = {};
    let selectedPredator = null;
    let isEditingFoodWeb = false;

    function showFoodWebForm() {
        const plantNames = [document.getElementById('plant1-name').value, document.getElementById('plant2-name').value];
        const animalNames = [
            document.getElementById('animal1-name').value,
            document.getElementById('animal2-name').value,
            document.getElementById('animal3-name').value,
            document.getElementById('animal4-name').value,
            document.getElementById('animal5-name').value
        ];
        
        speciesData = {
            plants: plantNames,
            animals: animalNames
        };

        const allSpecies = [...plantNames, ...animalNames];
        allSpecies.forEach((species, index) => {
            chartColors[species] = baseChartColors[index % baseChartColors.length];
        });

        setupPanel.style.display = 'none';
        foodwebPanel.style.display = 'block';
        resizeFoodWebCanvas(foodWebCanvas, foodWebContext);
        drawFoodWeb(foodWebContext, foodWebCanvas);
    }

    function resizeFoodWebCanvas(canvas, context) {
        canvas.width = canvas.offsetWidth;
        canvas.height = 400;
        drawFoodWeb(context, canvas);
    }

    function drawFoodWeb(context, canvas) {
        context.clearRect(0, 0, canvas.width, canvas.height);
        
        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        const numSpecies = allSpecies.length;
        const radius = Math.min(canvas.width, canvas.height) / 2.5;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const nodeSize = 10;
        
        speciesPositions = {};

        allSpecies.forEach((species, index) => {
            const angle = (index / numSpecies) * Math.PI * 2;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            
            speciesPositions[species] = { x, y };

            context.beginPath();
            context.arc(x, y, nodeSize, 0, Math.PI * 2);
            context.fillStyle = chartColors[species];
            context.fill();
            context.strokeStyle = '#333';
            context.stroke();
            
            context.fillStyle = '#333';
            context.font = '12px Arial';
            context.textAlign = 'center';
            context.fillText(species, x, y + nodeSize + 15);
        });
        
        for (const predator in foodWeb) {
            const preyList = foodWeb[predator] || [];
            preyList.forEach(prey => {
                const startPos = speciesPositions[predator];
                const endPos = speciesPositions[prey];
                if (startPos && endPos) {
                    context.beginPath();
                    context.strokeStyle = chartColors[predator];
                    context.lineWidth = 1;
                    context.moveTo(startPos.x, startPos.y);
                    context.lineTo(endPos.x, endPos.y);
                    context.stroke();
                }
            });
        }
    }

    function getClickedSpecies(x, y, canvas) {
        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        for (const species of allSpecies) {
            const pos = speciesPositions[species];
            if (pos) {
                const distance = Math.sqrt(Math.pow(pos.x - x, 2) + Math.pow(pos.y - y, 2));
                if (distance < 20) {
                    return species;
                }
            }
        }
        return null;
    }

    function handleFoodWebClick(event, context, canvas, messageDiv) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const clickedSpecies = getClickedSpecies(x, y, canvas);

        if (!clickedSpecies) return;

        if (selectedPredator) {
            if (selectedPredator === clickedSpecies) {
                selectedPredator = null;
                messageDiv.innerText = `${clickedSpecies} deselected.`;
            } else {
                if (!foodWeb[selectedPredator]) foodWeb[selectedPredator] = [];
                if (!foodWeb[selectedPredator].includes(clickedSpecies)) {
                    foodWeb[selectedPredator].push(clickedSpecies);
                    messageDiv.innerText = `${selectedPredator} now eats ${clickedSpecies}. Click on more prey or another predator.`;
                } else {
                    const index = foodWeb[selectedPredator].indexOf(clickedSpecies);
                    foodWeb[selectedPredator].splice(index, 1);
                    messageDiv.innerText = `${selectedPredator} no longer eats ${clickedSpecies}.`;
                    if (foodWeb[selectedPredator].length === 0) delete foodWeb[selectedPredator];
                }
            }
        } else {
            if (speciesData.animals.includes(clickedSpecies)) {
                selectedPredator = clickedSpecies;
                messageDiv.innerText = `${clickedSpecies} is now selected as the predator. Click on its prey.`;
            } else {
                messageDiv.innerText = `Please select an animal as a predator first.`;
            }
        }
        drawFoodWeb(context, canvas);
    }
    
    // Setup food web canvas click listener
    foodWebCanvas.addEventListener('click', (event) => {
        handleFoodWebClick(event, foodWebContext, foodWebCanvas, foodWebMessage);
    });

    function showPopulationForm() {
        const foodwebSetup = document.getElementById('foodweb-setup');
        const populationInputsDiv = document.getElementById('population-inputs');
        populationInputsDiv.innerHTML = '';
        const allSpecies = [...speciesData.plants, ...speciesData.animals];

        allSpecies.forEach(species => {
            const group = document.createElement('div');
            group.classList.add('form-group');
            group.innerHTML = `
                <label for="${species}-initial-pop">${species} starting population:</label>
                <input type="number" id="${species}-initial-pop" value="10" min="0">
            `;
            populationInputsDiv.appendChild(group);
        });
        foodwebSetup.style.display = 'none';
        document.getElementById('initial-population-form').style.display = 'block';
    }

    function startSimulation() {
        ecosystem = {
            gameTurn: 0,
            maxPlants: 50,
            maxAnimals: 20
        };
        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        allSpecies.forEach(species => {
            const popValue = document.getElementById(species + '-initial-pop').value;
            ecosystem[species] = parseInt(popValue) || 0;
        });
        
        for (const species of allSpecies) {
            chartData[species] = [ecosystem[species]];
        }
        
        setupPanel.style.display = 'none';
        foodwebPanel.style.display = 'none';
        gamePanel.style.display = 'flex';
        
        renderLegend();
        renderScene(
            "Your alien ecosystem has been created! Use the buttons below to simulate population changes and trigger ecological events.",
            getGameOptions()
        );
        resizeCanvas(chartCanvas, chartContext);
        resizeFoodWebCanvas(liveFoodWebCanvas, liveFoodWebContext);
    }
    
    function renderLegend() {
        chartLegend.innerHTML = '';
        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        allSpecies.forEach(species => {
            const legendItem = document.createElement('div');
            legendItem.classList.add('legend-item');
            legendItem.innerHTML = `
                <div class="legend-color" style="background-color: ${chartColors[species] || '#000'}"></div>
                <span>${species}</span>
            `;
            chartLegend.appendChild(legendItem);
        });
    }

    function resizeCanvas(canvas, context) {
        canvas.width = canvas.offsetWidth;
        canvas.height = 300;
        drawChart(context, canvas);
    }

    function drawChart(context, canvas) {
        if (isGameOver) return;
        context.clearRect(0, 0, canvas.width, canvas.height);
        
        const padding = 25;
        const chartWidth = canvas.width - padding * 2;
        const chartHeight = canvas.height - padding * 2;
        
        const allData = Object.values(chartData).flat();
        const maxPopulation = Math.max(...allData, ecosystem.maxAnimals * 2, ecosystem.maxPlants);

        context.beginPath();
        context.strokeStyle = '#ccc';
        context.moveTo(padding, padding);
        context.lineTo(padding, chartHeight + padding);
        context.lineTo(chartWidth + padding, chartHeight + padding);
        context.stroke();

        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        for (const species of allSpecies) {
            context.beginPath();
            context.strokeStyle = chartColors[species] || '#000';
            context.lineWidth = 2;
            
            if (chartData[species]) {
                chartData[species].forEach((population, index) => {
                    const x = padding + (chartWidth / (maxDataPoints - 1)) * index;
                    const y = padding + chartHeight - (chartHeight / maxPopulation) * population;
                    if (index === 0) {
                        context.moveTo(x, y);
                    } else {
                        context.lineTo(x, y);
                    }
                });
                context.stroke();
            }
        }
    }

    function updateStatus() {
        statusDisplay.innerHTML = '';
        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        allSpecies.forEach(species => {
            statusDisplay.innerHTML += `<p>${species}: ${ecosystem[species]}</p>`;
        });
        drawChart(chartContext, chartCanvas);
        drawFoodWeb(liveFoodWebContext, liveFoodWebCanvas); // Redraw live food web to show it's active
    }

    function renderScene(text, options) {
        if (isGameOver) return;
        gameOutput.innerHTML = `<p>${text}</p>`;
        optionsContainer.innerHTML = '';
        options.forEach(option => {
            let button = document.createElement('button');
            button.classList.add('option-button');
            button.innerText = option.text;
            button.onclick = () => {
                option.action();
                updateStatus();
            };
            optionsContainer.appendChild(button);
        });
        updateStatus();
    }
    
    function getGameOptions() {
        return [
            { text: "Simulate Next Turn", action: simulateTurn },
            { text: "Fire Disturbance", action: fireDisturbance },
            { text: "Water Disturbance", action: waterDisturbance },
            { text: "Lightning Disturbance", action: lightningDisturbance },
            { text: "Manage Populations", action: managePopulations },
            { text: "Modify Food Web", action: toggleFoodWebEditing }
        ];
    }
    
    function toggleFoodWebEditing() {
        isEditingFoodWeb = !isEditingFoodWeb;
        if (isEditingFoodWeb) {
            gameOutput.innerHTML = `<p><strong>Food Web Editing Mode: ON</strong>. Click on a predator, then on its prey to add or remove a relationship. Click the predator again to deselect.</p>`;
            liveFoodWebCanvas.addEventListener('click', liveFoodWebClickHandler);
            drawFoodWeb(liveFoodWebContext, liveFoodWebCanvas);
        } else {
            gameOutput.innerHTML = `<p><strong>Food Web Editing Mode: OFF</strong>. Back to simulation.</p>`;
            liveFoodWebCanvas.removeEventListener('click', liveFoodWebClickHandler);
            selectedPredator = null;
            drawFoodWeb(liveFoodWebContext, liveFoodWebCanvas);
        }
    }
    
    function liveFoodWebClickHandler(event) {
        handleFoodWebClick(event, liveFoodWebContext, liveFoodWebCanvas, liveFoodWebMessage);
    }
    
    function checkGameEnd() {
        let totalAnimals = 0;
        speciesData.animals.forEach(animal => totalAnimals += ecosystem[animal]);

        if (totalAnimals <= 0) {
            endGame("The ecosystem collapsed! All animal species have gone extinct. This demonstrates a complete food web failure.");
            return true;
        }
        let anyPlantsLeft = false;
        speciesData.plants.forEach(plant => {
            if (ecosystem[plant] > 0) anyPlantsLeft = true;
        });
        if (!anyPlantsLeft) {
            endGame("Game Over: All plant life has been wiped out, causing a total ecosystem collapse.");
            return true;
        }
        
        const overpopulationThreshold = ecosystem.maxAnimals * 2;
        let anyOverpopulated = false;
        speciesData.animals.forEach(animal => {
            if (ecosystem[animal] > overpopulationThreshold) anyOverpopulated = true;
        });
        if (anyOverpopulated) {
             endGame("Game Over: A single species population exploded, leading to overconsumption of resources and eventual collapse.");
             return true;
        }

        if (ecosystem.gameTurn >= 15) {
            endGame("You have successfully guided the ecosystem through several challenges! Your careful management helped maintain a delicate balance for many seasons. Congratulations!");
            return true;
        }
        return false;
    }

    function endGame(message) {
        isGameOver = true;
        drawChart(chartContext, chartCanvas);
        gameOutput.innerHTML = `<p><strong>Game Over!</strong> ${message}</p><p>Final Status:</p><p>${statusDisplay.innerHTML}</p><p>Refresh the page to play again.</p>`;
        optionsContainer.innerHTML = '';
        console.log("Game Over");
    }
    
    function simulateTimeStep() {
        if (isGameOver || isEditingFoodWeb) return;
        if (checkGameEnd()) return;
        ecosystem.gameTurn++;

        speciesData.plants.forEach(plant => {
            ecosystem[plant] += Math.floor(Math.random() * 5) + 1;
        });
        
        const animalSpecies = speciesData.animals;
        const plantSpecies = speciesData.plants;

        for (const predator of animalSpecies) {
            if (ecosystem[predator] <= 0) continue;
            
            const foodSources = foodWeb[predator] || [];
            let foodConsumed = 0;
            const energyNeeded = ecosystem[predator] * 1.5;

            for (const prey of foodSources) {
                if (ecosystem[prey] > 0) {
                    const amountEaten = Math.min(ecosystem[predator], ecosystem[prey]);
                    ecosystem[prey] -= amountEaten;
                    foodConsumed += amountEaten;
                }
            }

            if (foodConsumed > energyNeeded) {
                ecosystem[predator] += 1;
            } else if (foodConsumed < energyNeeded * 0.5) {
                ecosystem[predator] = Math.max(0, ecosystem[predator] - 1);
            }
        }
        
        speciesData.plants.forEach(plant => ecosystem[plant] = Math.min(ecosystem[plant], ecosystem.maxPlants));
        speciesData.animals.forEach(animal => ecosystem[animal] = Math.min(ecosystem[animal], ecosystem.maxAnimals));
        
        const allSpecies = [...plantSpecies, ...animalSpecies];
        for (const species of allSpecies) {
            chartData[species].push(ecosystem[species]);
            if (chartData[species].length > maxDataPoints) {
                chartData[species].shift();
            }
        }

        console.log("Time step simulation complete:", ecosystem);
    }
    
    function fireDisturbance() {
        const message = "A fire disturbance has swept through the ecosystem! Plant life and some animals have been severely impacted.";
        speciesData.plants.forEach(plant => {
            ecosystem[plant] = Math.max(0, ecosystem[plant] - Math.floor(Math.random() * 15) - 5);
        });
        speciesData.animals.forEach(animal => {
            ecosystem[animal] = Math.max(0, ecosystem[animal] - Math.floor(Math.random() * 3));
        });
        simulateTimeStep();
        renderScene(message, getGameOptions());
    }

    function waterDisturbance() {
        const message = "A heavy rain event has occurred! This has helped plant growth but created challenging conditions for some animals.";
        speciesData.plants.forEach(plant => {
            ecosystem[plant] = Math.min(ecosystem.maxPlants, ecosystem[plant] + Math.floor(Math.random() * 10) + 5);
        });
        speciesData.animals.forEach(animal => {
            ecosystem[animal] = Math.max(0, ecosystem[animal] - Math.floor(Math.random() * 2));
        });
        simulateTimeStep();
        renderScene(message, getGameOptions());
    }

    function lightningDisturbance() {
        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        const randomSpecies = allSpecies[Math.floor(Math.random() * allSpecies.length)];
        const amountReduced = Math.floor(Math.random() * 5) + 1;
        ecosystem[randomSpecies] = Math.max(0, ecosystem[randomSpecies] - amountReduced);

        const message = `A random lightning strike has hit! It has reduced the population of ${randomSpecies} by ${amountReduced}.`;
        simulateTimeStep();
        renderScene(message, getGameOptions());
    }

    function simulateTurn() {
        simulateTimeStep();
        renderScene(
            `A new turn has passed. The ecosystem has naturally fluctuated.`,
            getGameOptions()
        );
    }
    
    function managePopulations() {
        const allSpecies = [...speciesData.plants, ...speciesData.animals];
        const options = allSpecies.map(species => ({
            text: `Manage ${species}`,
            action: () => manageSpecificSpecies(species)
        }));
        options.push({ text: "Return to game.", action: () => renderScene("What's your next move?", getGameOptions()) });
        
        renderScene("You have chosen to intervene directly. What species do you want to manage?", options);
    }
    
    function manageSpecificSpecies(species) {
        renderScene(
            `You are managing the ${species} population. The current count is ${ecosystem[species]}. What do you want to do?`,
            [
                { text: `Introduce more ${species} (+5).`, action: () => adjustSpecies(species, 5, `You've introduced more ${species}. The population is now ${ecosystem[species] + 5}.`) },
                { text: `Hunt ${species} (-3).`, action: () => adjustSpecies(species, -3, `You've hunted some of the ${species} population. The population is now ${Math.max(0, ecosystem[species] - 3)}.`) },
                { text: "Go back to population management.", action: managePopulations }
            ]
        );
    }

    function adjustSpecies(species, amount, message) {
        ecosystem[species] = Math.max(0, ecosystem[species] + amount);
        simulateTimeStep();
        renderScene(message, getGameOptions());
    }

    window.onload = function() {
        setupPanel.style.display = 'block';
        window.addEventListener('resize', () => {
            if (setupPanel.style.display === 'block') {
                // do nothing
            } else if (foodwebPanel.style.display === 'block') {
                resizeFoodWebCanvas(foodWebCanvas, foodWebContext);
            } else {
                resizeCanvas(chartCanvas, chartContext);
                resizeFoodWebCanvas(liveFoodWebCanvas, liveFoodWebContext);
            }
        });
    };
</script>

</body>
</html>
